#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
T√©l√©chargement documentation Pentest & Cybers√©curit√© pour RAG
ADAPT√â POUR DISQUE D:
Kali Linux, Exploit-DB, OWASP, CVE, etc.
"""

import os
import subprocess
import requests
from pathlib import Path
import shutil
import json
import time
import zipfile
import tarfile
import sys

# Force encoding utf-8 for Windows consoles
sys.stdout.reconfigure(encoding='utf-8')

class PentestDocsDownloader:
    """T√©l√©charge la documentation pentesting et s√©curit√©"""
    
    def __init__(self, base_path: str):
        self.base_path = Path(base_path)
        self.raw_path = self.base_path / "raw"
        self.cleaned_path = self.base_path / "cleaned"
        
        self.raw_path.mkdir(parents=True, exist_ok=True)
        self.cleaned_path.mkdir(parents=True, exist_ok=True)
        
        print("="*70)
        print("üîí T√âL√âCHARGEMENT DOCUMENTATION PENTEST & CYBERS√âCURIT√â (Mode D:)")
        print("="*70 + "\n")
    
    def download_kali_docs(self):
        """T√©l√©charge la documentation Kali Linux"""
        
        print("\n" + "‚îÄ"*70)
        print("üêâ KALI LINUX")
        print("‚îÄ"*70 + "\n")
        
        kali_dir = self.raw_path / "kali-linux"
        kali_dir.mkdir(exist_ok=True)
        
        # 1. Clone du d√©p√¥t officiel Kali Docs
        print("1Ô∏è‚É£ Clone de la documentation Kali officielle...")
        kali_docs_repo = kali_dir / "kali-docs"
        
        if not kali_docs_repo.exists():
            try:
                subprocess.run([
                    "git", "clone", "--depth", "1",
                    "https://gitlab.com/kalilinux/documentation/kali-docs.git",
                    str(kali_docs_repo)
                ], check=True)
                print("   ‚úì Kali Docs clon√©es\n")
            except subprocess.CalledProcessError as e:
                print(f"   ‚ö† Erreur: {e}\n")
        else:
            print("   ‚äò Kali Docs d√©j√† pr√©sentes\n")
        
        # 2. Clone Kali Tools documentation (metadata)
        print("2Ô∏è‚É£ Clone des m√©tadonn√©es outils Kali...")
        kali_tools_repo = kali_dir / "kali-tools"
        if not kali_tools_repo.exists():
            try:
                subprocess.run([
                    "git", "clone", "--depth", "1",
                    "https://gitlab.com/kalilinux/packages/kali-meta.git",
                    str(kali_tools_repo)
                ], check=True)
                print("   ‚úì Kali Tools metadata clon√©es\n")
            except:
                print("   ‚ö† Erreur clone tools\n")
        else:
            print("   ‚äò Kali Tools d√©j√† pr√©sentes\n")

    def download_exploitdb(self):
        """T√©l√©charge la base Exploit-DB compl√®te"""
        print("\n" + "‚îÄ"*70)
        print("üí• EXPLOIT-DB")
        print("‚îÄ"*70 + "\n")
        
        exploitdb_dir = self.raw_path / "exploit-db"
        exploitdb_dir.mkdir(exist_ok=True)
        
        # Clone du d√©p√¥t Exploit-DB complet
        print("1Ô∏è‚É£ Clone Exploit-DB (~190 MB)...")
        exploitdb_repo = exploitdb_dir / "exploitdb"
        
        if not exploitdb_repo.exists():
            try:
                subprocess.run([
                    "git", "clone", "--depth", "1",
                    "https://github.com/offensive-security/exploitdb.git",
                    str(exploitdb_repo)
                ], check=True)
                print(f"   ‚úì Exploit-DB clon√©e\n")
            except subprocess.CalledProcessError as e:
                print(f"   ‚ö† Erreur: {e}\n")
        else:
            print("   ‚äò Exploit-DB d√©j√† pr√©sente\n")
        
        # Papers if available in repo
        # Index generation skipped for now to focus on download

    def download_owasp_guides(self):
        """T√©l√©charge les guides OWASP"""
        print("\n" + "‚îÄ"*70)
        print("üõ°Ô∏è  OWASP GUIDES")
        print("‚îÄ"*70 + "\n")
        
        owasp_dir = self.raw_path / "owasp"
        owasp_dir.mkdir(exist_ok=True)
        
        guides = {
            "testing-guide-v5": "https://github.com/OWASP/wstg.git",
            "top10": "https://github.com/OWASP/Top10.git",
            "cheatsheets": "https://github.com/OWASP/CheatSheetSeries.git",
            "asvs": "https://github.com/OWASP/ASVS.git"
        }

        for name, url in guides.items():
            print(f"üì¶ Clone {name}...")
            target_dir = owasp_dir / name
            if not target_dir.exists():
                try:
                    subprocess.run(["git", "clone", "--depth", "1", url, str(target_dir)], check=True)
                    print(f"   ‚úì {name} clon√©\n")
                except:
                    print(f"   ‚ö† Erreur {name}\n")
            else:
                print(f"   ‚äò {name} d√©j√† pr√©sent\n")

    def download_metasploit_docs(self):
        print("\n" + "‚îÄ"*70)
        print("‚öîÔ∏è  METASPLOIT")
        print("‚îÄ"*70 + "\n")
        msf_dir = self.raw_path / "metasploit"
        msf_dir.mkdir(exist_ok=True)
        
        msf_repo = msf_dir / "metasploit-framework"
        if not msf_repo.exists():
            try:
                subprocess.run([
                    "git", "clone", "--depth", "1", "--filter=blob:none", "--sparse",
                    "https://github.com/rapid7/metasploit-framework.git", str(msf_repo)
                ], check=True)
                os.chdir(msf_repo)
                subprocess.run(["git", "sparse-checkout", "set", "documentation"], check=True)
                os.chdir(self.base_path)
                print("   ‚úì Metasploit docs clon√©es\n")
            except:
                print("   ‚ö† Erreur Metasploit\n")
        else:
            print("   ‚äò Metasploit d√©j√† pr√©sent\n")

    def download_nmap_docs(self):
        print("\n" + "‚îÄ"*70)
        print("üîç NMAP")
        print("‚îÄ"*70 + "\n")
        nmap_dir = self.raw_path / "nmap"
        nmap_dir.mkdir(exist_ok=True)
        nmap_repo = nmap_dir / "nmap"
        if not nmap_repo.exists():
            try:
                subprocess.run(["git", "clone", "--depth", "1", "https://github.com/nmap/nmap.git", str(nmap_repo)], check=True)
                print("   ‚úì Nmap docs clon√©es\n")
            except: pass
        else: print("   ‚äò Nmap d√©j√† pr√©sent\n")

    def download_cve_databases(self):
        print("\n" + "‚îÄ"*70)
        print("üîê CVE DATABASE (Optionnel - D√©sactiv√© par d√©faut car trop volumineux/instable)")
        print("‚îÄ"*70 + "\n")
        # Les bases NVD JSON sont tr√®s lourdes et l'API limite souvent.
        # Pour un RAG local, Exploit-DB (d√©j√† t√©l√©charg√©) suffit g√©n√©ralement.
        print("   ‚ÑπÔ∏è  T√©l√©chargement CVE ignor√© pour stabilit√©. Utilisez ExploitDB inclus.\n")
        return
        
        # cve_dir = self.raw_path / "cve-databases" / "nvd-cve"
        # cve_dir.mkdir(parents=True, exist_ok=True)
        # ... (code d√©sactiv√©)

    def extract_and_clean(self):
        print("\n" + "‚îÄ"*70)
        print("üìÑ EXTRACTION ET NETTOYAGE")
        print("‚îÄ"*70 + "\n")
        
        doc_extensions = ['.md', '.txt', '.rst', '.html', '.pdf']
        exclude_dirs = ['.git', 'node_modules', 'vendor']
        
        for category_dir in self.raw_path.iterdir():
            if not category_dir.is_dir() or category_dir.name.startswith('.'): continue
            
            print(f"üìÇ Traitement: {category_dir.name}")
            for file_path in category_dir.rglob("*"):
                if any(excl in file_path.parts for excl in exclude_dirs): continue
                if file_path.suffix.lower() not in doc_extensions: continue
                if not file_path.is_file(): continue
                
                try:
                    rel_path = file_path.relative_to(category_dir)
                    target = self.cleaned_path / category_dir.name / rel_path
                    target.parent.mkdir(parents=True, exist_ok=True)
                    shutil.copy2(file_path, target)
                except: pass
            print("   ‚úì OK")

    def run(self):
        try:
            self.download_kali_docs()
            self.download_exploitdb()
            self.download_owasp_guides()
            self.download_metasploit_docs()
            self.download_nmap_docs()
            self.download_cve_databases()
            self.extract_and_clean()
            
            print("\n" + "="*70)
            print("‚úÖ TERMIN√â")
            print("="*70)
            print(f"üìÇ Destination: {self.base_path}")
            
        except KeyboardInterrupt: print("\n‚ö†Ô∏è Interrompu.")
        except Exception as e: print(f"\n‚ùå Erreur: {e}")

if __name__ == "__main__":
    base_path = "D:/RAG_Knowledge/Docs/Pentest"
    print(f"üìç Destination: {base_path}")
    downloader = PentestDocsDownloader(base_path)
    downloader.run()
